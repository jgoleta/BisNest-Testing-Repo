{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales | BisNest</title>
        <link rel="stylesheet" href="{% static 'css/centralStyle.css' %}">
        <link rel="stylesheet" href="{% static 'css/salesStyle.css' %}">
</head>

<body>
    <div class="bg-shape"></div>
    <input type="checkbox" id="sidebarToggle" style="display: none;">
    <label for="sidebarToggle" class="burger">
        <span></span>
        <span></span>
        <span></span>
    </label>
    <label for="sidebarToggle" class="overlay"></label>

    <nav class="navigation-top">
        <div class="navigation-div">
            <h1 class="page-name">Supply Management</h1>
            <ul style="margin-left: 45%;">
                <li><a style="color: #1e293b;" href="{% url 'about' %}">About</a></li>
                <li><a style="color: #1e293b;" href="#contact">Contact</a></li>
            </ul>
        </div>
    </nav>

    <nav class="sidebar">
        <ul>
            <ul>
                <li><a href="{% url 'menu' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" />
                        </svg>Home</a></li>
                <li><a href="{% url 'employeesinfo' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-5 0-9 2.5-9 6v1h18v-1c0-3.5-4-6-9-6z" />
                        </svg>Employee</a></li>
                <li><a href="{% url 'customer' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path
                                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zM8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5C23 14.17 18.33 13 16 13z" />
                        </svg>Customer</a></li>
                <li><a href="{% url 'product' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M21 8l-9-5-9 5v8l9 5 9-5V8zM12 3v18" />
                        </svg>Product</a></li>
                <li><a href="{% url 'history' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M7 3h10v4H7zM7 9h10v12H7zM9 11h6v2H9zM9 15h6v2H9z" />
                        </svg>Order</a></li>
                <li><a href="{% url 'payment' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <rect x="2" y="5" width="20" height="14" rx="2" />
                            <path d="M2 10h20" fill="#fff" />
                        </svg>Payment</a></li>
                <li><a href="{% url 'delivery' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M3 7h13l4 4v6h-2a3 3 0 0 1-6 0H8a3 3 0 0 1-6 0V7zM16 8v4h3" />
                        </svg>Delivery</a></li>
                <li><a href="{% url 'supply' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <path d="M21 16V8l-9-5-9 5v8l9 5 9-5z" />
                        </svg>Supply</a></li>
                <li><a href="{% url 'sales' %}"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="vertical-align:middle;margin-right:8px">
                            <rect x="3" y="11" width="4" height="10" />
                            <rect x="10" y="7" width="4" height="14" />
                            <rect x="17" y="3" width="4" height="18" />
                        </svg>Sales Report</a></li>
            </ul>
            <ul>
                <hr>
                <li><a href="{% url 'logout_view' %}" class="btn-signout"><svg class="signout-icon"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" />
                        </svg>Sign Out</a></li>
            </ul>
        </ul>
    </nav>

    <main class="main-content">

        <div class="year-selector">
            <label for="yearSelect">Select Year:</label>
            <select id="yearSelect" onchange="filterByYear()">
                <option value="">All Years</option>
            </select>
        </div>

        <div class="yearly-summary">
            <div class="summary-card">
                <h3>Total Sales</h3>
                <div class="value" id="totalSales">₱0.00</div>
            </div>
            <div class="summary-card">
                <h3>Average Monthly</h3>
                <div class="value" id="avgMonthly">₱0.00</div>
            </div>
            <div class="summary-card">
                <h3>Total Transactions</h3>
                <div class="value" id="totalTransactions">0</div>
            </div>
            <div class="summary-card">
                <h3>Best Month</h3>
                <div class="value" id="bestMonth">-</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('detailed')">Detailed Sales</button>
            <button class="tab" onclick="switchTab('monthly')">Monthly Sales</button>
        </div>

        <div id="detailed-tab" class="tab-content active">
            <form method="POST" class="form">
                <input type="text" id="searchInput" placeholder="Search Product Name:" onkeyup="searchProduct()">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="submit-button">Submit</button>
            </form>

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Product Name</th>
                            <th>Quantity Sold</th>
                            <th>Price</th>
                            <th>Total (₱)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        {% for sale in sales %}
                        <tr>
                            <td>{{ sale.date }}</td>
                            <td>{{ sale.product.name }}</td>
                            <td>{{ sale.quantity_sold }}</td>
                            <td>₱{{ sale.price }}</td>
                            <td class="row-total">₱{{ sale.total }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="edit-button" data-id="{{ cust.id }}"
                                        data-name="{{ cust.name }}" data-phone="{{ cust.phone }}"
                                        data-address="{{ cust.address }}" title="Edit customer"
                                        aria-label="Edit customer">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                            <path
                                                d="M3 21v-3.75L14.81 5.44a2 2 0 0 1 2.83 0l0.92 0.92a2 2 0 0 1 0 2.83L6.75 21H3z"
                                                stroke="currentColor" stroke-width="1" stroke-linecap="round"
                                                stroke-linejoin="round" />
                                            <path
                                                d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
                                                stroke="currentColor" stroke-width="1" stroke-linecap="round"
                                                stroke-linejoin="round" />
                                        </svg>
                                    </button>

                                    <form method="POST" action="{% url 'delete_sale' sale.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="delete-button" aria-label="Delete sale"><svg
                                                xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                <path
                                                    d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                                                <path
                                                    d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                                            </svg></button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="grand-total-row">
                            <td colspan="4" style="text-align: right; font-weight: bold;">Grand Total:</td>
                            <td id="grandTotal">₱0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="monthly-tab" class="tab-content">
            <div class="monthly-breakdown">
                <h3>Monthly Sales</h3>
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Total Sales (₱)</th>
                            <th>Transactions</th>
                            <th>Average per Transaction</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    <script>
        let salesData = [];
        let currentYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', function () {
            loadSalesData();
            populateYearSelector();
            filterByYear();
            updateYearlySummary();
            updateMonthlyBreakdown();
        });

        function loadSalesData() {
            salesData = [];
            document.querySelectorAll('.table-body tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const date = cells[0].textContent.trim();
                    const productName = cells[1].textContent.trim();
                    const quantity_sold = parseFloat(cells[2].textContent.replace(/[₱,]/g, '')) || 0;
                    const price = parseFloat(cells[3].textContent.replace(/[₱,]/g, '')) || 0;
                    const total = parseFloat(cells[4].textContent.replace(/[₱,]/g, '')) || 0;

                    salesData.push({
                        date: date,
                        productName: productName,
                        quantity_sold: quantity_sold,
                        price: price,
                        total: total
                    });
                }
            });
        }

        function populateYearSelector() {
            const years = [...new Set(salesData.map(sale => new Date(sale.date).getFullYear()))];
            years.sort((a, b) => b - a);

            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
        }

        function filterByYear() {
            const selectedYear = document.getElementById('yearSelect').value;
            currentYear = selectedYear || new Date().getFullYear();
            updateYearlySummary();
            updateMonthlyBreakdown();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function updateYearlySummary() {
            const filteredData = currentYear ?
                salesData.filter(sale => new Date(sale.date).getFullYear() == currentYear) :
                salesData;

            const totalSales = filteredData.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = filteredData.length;
            const avgMonthly = totalSales / 12;

            const monthlyData = getMonthlyData(filteredData);
            const bestMonthData = monthlyData.reduce((max, month) =>
                month.total > max.total ? month : max, { month: 'N/A', total: 0 });

            document.getElementById('totalSales').textContent = `₱${totalSales.toFixed(2)}`;
            document.getElementById('avgMonthly').textContent = `₱${avgMonthly.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('bestMonth').textContent = bestMonthData.month;
        }

        function updateMonthlyBreakdown() {
            const filteredData = currentYear ?
                salesData.filter(sale => new Date(sale.date).getFullYear() == currentYear) :
                salesData;

            const monthlyData = getMonthlyData(filteredData);
            const monthlyTableBody = document.getElementById('monthlyTableBody');

            monthlyTableBody.innerHTML = '';
            monthlyData.forEach(month => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month.month}</td>
                    <td>₱${month.total.toFixed(2)}</td>
                    <td>${month.transactions}</td>
                    <td>₱${month.avgPerTransaction.toFixed(2)}</td>
                `;
                monthlyTableBody.appendChild(row);
            });
        }

        function getMonthlyData(data) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            const monthlyTotals = {};

            months.forEach(month => {
                monthlyTotals[month] = {
                    total: 0,
                    transactions: 0
                };
            });

            data.forEach(sale => {
                const monthIndex = new Date(sale.date).getMonth();
                const monthName = months[monthIndex];
                monthlyTotals[monthName].total += sale.total;
                monthlyTotals[monthName].transactions += 1;
            });

            return months.map(month => ({
                month: month,
                total: monthlyTotals[month].total,
                transactions: monthlyTotals[month].transactions,
                avgPerTransaction: monthlyTotals[month].transactions > 0 ?
                    monthlyTotals[month].total / monthlyTotals[month].transactions : 0
            }));
        }
        window.addEventListener('load', () => {
            let total = 0;
            document.querySelectorAll(".row-total").forEach(cell => {
                total += parseFloat(cell.textContent.replace(/[₱,]/g, '')) || 0;
            });
            document.getElementById("grandTotal").textContent = `₱${total.toFixed(2)}`;
        });
    </script>
</body>

</html>